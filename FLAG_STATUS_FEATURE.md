# 互助旗狀態功能說明

## 功能概述

「任務完成 降下互助旗」功能讓用戶可以在完成學習任務或暫時不需要協助時，將自己從地圖和配對系統中暫時隱藏。

## 功能特色

### 1. 雙向同步開關
- 在「設定」頁面和「我的互助旗」頁面都有相同的開關
- 兩個開關是完全同步的，改變其中一個會自動更新另一個
- 支援本地儲存和 Firebase 雲端同步

### 2. 智慧狀態管理
- **互助旗升起**：用戶可見，可以配對和被配對
- **互助旗降下**：用戶隱藏，無法配對也不會被配對

### 3. 視覺化狀態指示
- 使用不同顏色和圖示表示狀態
- 升起時：橘色旗幟圖示 🏳️
- 降下時：灰色虛線旗幟圖示 🏳️‍⚪

## 技術實作

### Provider 狀態管理
```dart
class FlagStatusProvider extends ChangeNotifier {
  bool _isFlagDown = false;
  
  // 互助旗是否升起（可見狀態）
  bool get isFlagUp => !_isFlagDown;
  
  // 設定互助旗狀態
  Future<void> setFlagStatus(bool flagDown) async {
    // 同時儲存到本地和 Firebase
  }
}
```

### Firebase 資料結構
```json
{
  "users": {
    "userId": {
      "flag_down": true/false,
      "last_flag_update": 1234567890,
      // ... 其他用戶資料
    }
  }
}
```

## 功能影響範圍

### 1. 地圖功能 (`map_screen.dart`)
- 過濾掉 `flag_down: true` 的用戶
- 這些用戶不會在「附近的人」地圖中顯示

### 2. 配對功能 (`match_screen.dart`)
- 當自己的互助旗降下時，顯示特殊UI提示用戶無法配對
- 過濾掉其他 `flag_down: true` 的用戶
- 提供快速重新升起互助旗的按鈕

### 3. 設定頁面 (`settings_screen.dart`)
- 新增「互助旗狀態」區塊
- 詳細的功能說明和狀態指示
- 即時狀態切換和反饋

### 4. 個人資料頁面 (`profile_screen.dart`)
- 在頁面頂部顯示互助旗狀態卡片
- 簡潔的狀態說明和快速切換

## 用戶體驗設計

### 狀態說明文字
- **升起時**：「互助旗升起中 - 其他人可以看到你並與你配對」
- **降下時**：「互助旗已降下 - 暫時隱藏，不會出現在地圖和配對中」

### 操作反饋
- 狀態切換時顯示 SnackBar 確認訊息
- 載入狀態顯示圓形進度指示器
- 錯誤處理和使用者友善的錯誤訊息

### 配對頁面特殊處理
當用戶的互助旗降下時，配對頁面會顯示：
- 大型灰色旗幟圖示
- 「互助旗已降下」標題
- 「任務完成時無法進行配對」說明
- 「重新升起互助旗」按鈕

## 資料持久化

### 本地儲存 (SharedPreferences)
- 儲存鍵：`flag_down`
- 提供離線支援和快速載入

### 雲端同步 (Firebase Realtime Database)
- 路徑：`users/{uid}/flag_down`
- 附加時間戳：`last_flag_update`
- 支援多裝置同步

## 安全性考量

- 只有登入用戶可以修改自己的互助旗狀態
- 使用 Firebase 安全規則保護資料
- 本地和雲端資料雙重驗證

## 未來擴展可能

1. **定時自動升起**：設定一段時間後自動升起互助旗
2. **狀態歷史**：記錄互助旗升降的歷史記錄
3. **群組設定**：允許特定群組成員仍能看到降下旗幟的用戶
4. **智慧推薦**：根據互助旗狀態優化配對算法

## 測試建議

1. 測試兩個頁面的開關同步
2. 驗證地圖過濾功能
3. 確認配對功能的狀態檢查
4. 測試網路斷線時的本地儲存
5. 驗證多裝置間的狀態同步

這個功能提供了用戶完全的控制權，讓他們可以根據自己的學習狀態和需求，靈活地管理自己在平台上的可見性。 